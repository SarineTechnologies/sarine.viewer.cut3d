/*!
sarine.viewer.cut3d - v0.17.1 -  Thursday, April 27th, 2017, 10:48:08 AM 
 The source code, name, and look and feel of the software are Copyright © 2015 Sarine Technologies Ltd. All Rights Reserved. You may not duplicate, copy, reuse, sell or otherwise exploit any portion of the code, content or visual design elements without express written permission from Sarine Technologies Ltd. The terms and conditions of the sarine.com website (http://sarine.com/terms-and-conditions/) apply to the access and use of this software.
 */
(function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};b=function(){function a(b){console.log(""),this.first_init_defer=$.Deferred(),this.full_init_defer=$.Deferred(),this.src=b.src,this.element=b.element,this.autoPlay=b.autoPlay,this.callbackPic=b.callbackPic,this.id=this.element[0].id,this.element=this.convertElement(),Object.getOwnPropertyNames(a.prototype).forEach(function(a){if("Error"===this[a].name)return console.error(this.id,a,"Must be implement",this)},this),this.element.data("class",this),this.element.on("play",function(a){return $(a.target).data("class").play.apply($(a.target).data("class"),[!0])}),this.element.on("stop",function(a){return $(a.target).data("class").stop.apply($(a.target).data("class"),[!0])}),this.element.on("cancel",function(a){return $(a.target).data("class").cancel().apply($(a.target).data("class"),[!0])})}var b;return b=ResourceManager.getInstance(),function(){return console.error(this.id,"must be implement")},a.prototype.first_init=Error,a.prototype.full_init=Error,a.prototype.play=Error,a.prototype.stop=Error,a.prototype.convertElement=Error,a.prototype.cancel=function(){return b.cancel(this)},a.prototype.loadImage=function(a){return b.loadImage.apply(this,[a])},a.prototype.setTimeout=function(a,c){return b.setTimeout.apply(this,[this.delay,c])},a}(),this.Viewer=b,a=function(a){function b(a){b.__super__.constructor.call(this,a),k=a.color,q=a.font,s=a.infoOnly,k=k||16777215,D=1,i=12e3,h=1e4,G=a.stoneProperties.shape.toLowerCase(),this.version=$(this.element).data("version")||"v1",this.viewersBaseUrl=stones[0].viewersBaseUrl}var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;return d(b,a),c=void 0,E=void 0,F=void 0,A=void 0,void 0,u=void 0,b.material=void 0,f=void 0,g=void 0,D=void 0,void 0,r=void 0,j=void 0,void 0,k=void 0,q=void 0,v=!1,w=!1,x=!1,s=!1,r=!1,p=void 0,G=void 0,i=void 0,h=void 0,b.prototype.getScene=function(){return E},b.prototype.getSceneInfo=function(){return F},b.prototype.getRenderer=function(){return A},b.prototype.convertElement=function(){return this.element.css({width:"100%",height:"100%","min-width":200,"min-height":200}),this.element},b.prototype.full_init=function(){var a,b;return b=this,a=$.Deferred(),this.showLoader(b),t(this.viewersBaseUrl+"atomic/"+this.version+"/assets/three.bundle.js").then(function(){var c;return c=b.viewersBaseUrl+"atomic/"+b.version+"/assets/cut3d.css",$("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",c),this.fullSrnSrc=-1!==b.src.indexOf("##FILE_NAME##")?b.src.replace("##FILE_NAME##","SRNSRX.srn"):b.src,this.fullJsonSrc=-1!==b.src.indexOf("##FILE_NAME##")?b.src.replace("##FILE_NAME##","Info.json"):b.src,$.when($.get(this.fullSrnSrc),$.getJSON(this.fullJsonSrc)).then(function(c,d){var f;return d[0].Length.mm,console.log(d[0]),D=1,l.apply(b),r=d[0],f=c[0].replace(/\s/g,"^").match(/Mesh(.*?)}/)[0].replace(/[Mesh|{|}]/g,"").split("^").filter(function(a){return a.length>0}),n.apply(b,[{vertices:f.slice(1,+parseInt(f[0])+1||9e9).map(function(a){return a.replace(",","").split(";").slice(0,3)}),polygons:f.slice(parseInt(f[0])+2,+f.length+1||9e9).map(function(a){return a.replace(/(\d+;)/,"").replace(/(;;|;,)/,"").split(",")})}]),b.hideLoader(),s||e.apply(b),a.resolve(b)}).fail(function(){return b.loadImage(b.callbackPic).then(function(c){var d;return d=$("<canvas >"),d.attr({class:"no_stone",width:c.width,height:c.height}),d[0].getContext("2d").drawImage(c,0,0,c.width,c.height),b.hideLoader(),b.element.append(d),a.resolve(b)}),a})}),a},b.prototype.first_init=function(){var a;return a=$.Deferred(),a.resolve(this),a},b.prototype.showLoader=function(a){var b;return b=$('<div class="cut3d-spinner"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>'),a.element.append(b)},b.prototype.hideLoader=function(){return $(".cut3d-spinner").hide()},b.prototype.webglDetect=function(a){var b,c,d,e;if(window.WebGLRenderingContext){for(b=document.createElement("canvas"),e=["webgl","experimental-webgl","moz-webgl","webkit-3d"],c=!1,d=0;d<e.length;){try{if((c=b.getContext(e[d]))&&"function"==typeof c.getParameter)return!a||{name:e[d],gl:c}}catch(a){a}d++}return!1}return!1},b.prototype.play=function(){},b.prototype.stop=function(){},t=function(a){var b,d,e,f;return d=function(){return c=GetTHREE(),b.resolve(f)},f=this,b=$.Deferred(),$("[src='"+a+"']")[0]?($("[src='"+a+"']").on("load",d),b):(e=$("<script>",{type:"text/javascript"}).appendTo("body").end()[0],e.onload=d,e.src=a,b)},B=function(a,b){return u.rotation.x+=b/100,u.rotation.z-=a/100},e=function(){var a,b,c,d,e,f;return A.domElement,d=function(a){var b,c;if(v)return a.preventDefault(),b=a.clientX-w,c=a.clientY-x,w=a.clientX,x=a.clientY,B(b,c)},e=function(a){return a.preventDefault(),v=!0,w=a.clientX,x=a.clientY},f=function(a){return a.preventDefault(),v=!1},c=function(a){return function(a){if(1===a.touches.length)return a.preventDefault(),w=a.touches[0].pageX,x=a.touches[0].pageY}}(),b=function(a){return function(a){var b,c;if(1===a.touches.length)return a.preventDefault(),b=a.touches[0].pageX-w,c=a.touches[0].pageY-x,w=a.touches[0].pageX,x=a.touches[0].pageY,B(b,c)}}(),A.domElement.addEventListener("touchstart",c,!1),a=document.getElementsByClassName("viewer cut3DView"),a[0].addEventListener("touchend",f,!1),a[0].addEventListener("touchmove",b,!1),a[0].addEventListener("mousemove",d,!1),A.domElement.addEventListener("mousedown",e,!1),a[0].addEventListener("mouseup",f,!1)},z=function(){if(u&&(p.rotation.x=u.rotation.x,p.rotation.z=u.rotation.z,p.updateMatrix()),s||requestAnimationFrame(z),A.clear(),A.render(E,f),u&&u.rotation&&(parseInt(u.rotation.x/(Math.PI/2)+.95)-1)%4==0&&(parseInt(u.rotation.x/(Math.PI/2)+.05)-1)%4==0)return A.render(F,g)},n=function(a){var b,d,e,f,g,h,i,j,k;for(d=function(a,b){return b.faces.push(new c.Face3(a[0],a[1],a[2])),3!==a.length&&(a.splice(1,1),d(a,b)),b.computeFaceNormals()},b=new c.Geometry,j=a.vertices,f=0,h=j.length;f<h;f++)e=j[f],b.vertices.push(new c.Vector3(e[0]*D,e[1]*D,e[2]*D));for(k=a.polygons,g=0,i=k.length;g<i;g++)e=k[g],e.length>1&&d(e,b);return u=new c.Mesh(b,this.material),u.material.opacity=1,u.material.transparent=!1,u.geometry.center(),E.add(C(u)),p=new c.EdgesHelper(u.clone(),0),p.renderOrder=1,p.material.linewidth=2,E.add(C(p)),p.position.setZ(100),p.updateMatrix(),u},C=function(a){return a.rotation.x=Math.PI/2,a},l=function(){return E=new c.Scene,F=new c.Scene,f=new c.OrthographicCamera(i/-2.5,i/2.5,i/2.5,i/-2.5,-h,h),E.add(f),f.position.set(0,0,5e3),f.lookAt(E.position),A=new c.WebGLRenderer({alpha:!0,logarithmicDepthBuffer:!1,antialias:!0}),A.autoClear=!1,j=this.element.parent().height()>this.element.parent().width()?this.element.parent().width():this.element.parent().height(),g=new c.OrthographicCamera(j/-2,j/2,j/2,j/-2,-h,h),F.add(g),$(A.domElement).on("top",function(){return u.rotation.x=Math.PI}),$(A.domElement).on("side",function(){return u.rotation.x=Math.PI/2}),$(A.domElement).on("bottom",function(){return u.rotation.x=0}),$(A.domElement).on("transparent",function(){return u.material.opacity=1===u.material.opacity?0:1,u.material.transparent=!u.material.transparent}),A.setPixelRatio(window.devicePixelRatio?window.devicePixelRatio:1),A.setSize(j,j),this.element[0].appendChild(A.domElement),this.material=new c.MeshBasicMaterial({color:13421772}),z()},y=function(a){return a.set(a.x/(f.right/g.right),a.y/(f.top/g.top),a.z/(f.right/g.right)),a},m=function(a){var b,d,e,h,i,j,k,l,m,n,p,q;return a.name,l=a.origin,k=a.length,i=a.hex,n=a.topToButtom,b=a.data,d=a.dir,e=a.far,q=n?"x":"y",l["set"+q.toUpperCase()](l[q]*e),l=y(l),m=o({texts:b,position:l,names:Object.getOwnPropertyNames(b).filter(function(a){return a.indexOf("mm")>-1||a.indexOf("percentages")>-1})}),j=new c.Object3D,j.name="info",p=n?"y":"x",h=5,n?(m.children.forEach(function(a){return a.position.setX((l.x>0?h:-1*h)+l.x+a.geometry.boundingBox[l.x>0?"max":"min"].x)}),h=0):(h+=Math.max.apply({},m.children.map(function(a){return a.geometry.boundingBox.max[p]})),h-=Math.min.apply({},m.children.map(function(a){return a.geometry.boundingBox.min[p]}))),k=(b.mm?b.mm:b["height-mm"])/2*1e3/(f.right/g.right)-h/2,k*=D,j.add(m),j.add(new c.ArrowHelper(d,l.clone()["set"+p.toUpperCase()](l[p]+h/2),k,i,5,5)),n?d.setY(-1*d.y):d.setX(-1*d.x),j.add(new c.ArrowHelper(d,l.clone()["set"+p.toUpperCase()](l[p]-h/2),k,i,5,5)),j},o=function(a){var b,d,e;return a.texts,d=a.position,a.hex,a.names,a.toFixed,e=new c.Object3D,b=new c.MeshBasicMaterial({color:a.hex||0}),a.names.forEach(function(g){return function(g,h){var i,j,k,l;return j=function(){switch(!1){case!(g.indexOf("mm")>-1):return a.texts[g].toFixed(a.toFixed||2)+"mm";case!(g.indexOf("percentages")>-1):return a.texts[g].toFixed(a.toFixed||1)+"%";case!(g.indexOf("deg")>-1):return a.texts[g].toFixed(a.toFixed||1)+"°"}}(),k=new c.TextGeometry(j,{size:6+4*D>10?10:6+4*D,font:"gentilis",wieght:"bold"}),k.center(),i=function(){switch(!1){case 1!==a.names.length:return 0;case!(a.names.length%2==0&&0===h):return 1.3*k.boundingBox.max.y;case!(a.names.length%2==0&&1===h):return 1.3*k.boundingBox.min.y}}(),l=new c.Mesh(k,b),l.lookAt(f.position),l.position.set(d.x,d.y+i,d.z),e.add(l)}}()),e},function(a){var b,d,e,f,g,h,i,j,k,l,n,p,q,s,t,v,w,x,A;a=a||0,s=new c.Object3D,s.name="info",s.add(m({origin:new c.Vector3(0,u.geometry.boundingBox.max.z,0),hex:a,topToButtom:!1,data:r.Length,dir:new c.Vector3(1,0,0),far:1.5})),s.add(m({origin:new c.Vector3(0,u.geometry.boundingBox.max.z,0),hex:a,topToButtom:!1,data:r["Table Size"],dir:new c.Vector3(1,0,0),far:1.25})),w=1e3*r["Total Depth"].mm/2,n=w-1e3*r.Crown["height-mm"],b=new c.Vector3(u.geometry.boundingBox.max.x,(n+1e3*r.Crown["height-mm"]/2)*D,0),s.add(m({origin:b.clone(),hex:a,topToButtom:!0,data:r.Crown,dir:b.clone().setY(b.y+1),far:1.05})),h=new c.Vector3(u.geometry.boundingBox.max.x,(n-w)/2*D,0),s.add(m({origin:h.clone(),hex:a,topToButtom:!0,data:r.Pavilion,dir:h.clone().setY(-1*h.y),far:1.05})),k=new c.Vector3(u.geometry.boundingBox.min.x,0,0),s.add(m({origin:k.clone(),hex:a,topToButtom:!0,data:r["Total Depth"],dir:k.clone().setY(k.y+1),far:1.05})),s.add(o({texts:r["Culet Size"],position:y(new c.Vector3(0,1.1*u.geometry.boundingBox.min.z,0)),names:["percentages"],toFixed:2})),A=1e3*r["Table Size"].mm/2,x=1e3*r.Length.mm/2,s.add(o({texts:r.Crown,position:y(new c.Vector3((A+7*(x-A)/8)*D,1.05*b.y,0)),names:["angel-deg"],toFixed:"0"})),p=1.25,q=.1,s.add(o({texts:r.Pavilion,position:y(new c.Vector3(2*x/3*D,1.1*h.y,0)),names:["angel-deg"],toFixed:"0"})),g=new c.Vector3(1.05*u.geometry.boundingBox.min.x,n*D,0),f=y(g.clone()),i=o({texts:r.Girdle,position:f.clone().setX(f.x*p).setY(f.y+f.y*q),names:["Thickness-mm"]}),i.position.setX(i.position.x-5),v=new c.LineBasicMaterial({color:a}),l=new c.Geometry,l.vertices.push(new c.Vector3(i.children[0].position.x+i.children[0].geometry.boundingBox.max.x,i.children[0].position.y,i.children[0].position.z),new c.Vector3(f.x,f.y,f.z)),t=new c.Line(l,v),s.add(i),s.add(t),e=new c.Vector3(1.05*u.geometry.boundingBox.min.x,(n-1e3*r.Girdle["Thickness-mm"])*D,0),d=y(e.clone()),j=o({texts:r.Girdle,position:d.clone().setX(d.x*p).setY(d.y-d.y*q),names:["Thickness-percentages"]}),j.position.setX(.75*(i.position.x+i.children[0].geometry.boundingBox.max.x-j.children[0].geometry.boundingBox.max.x)),v=new c.LineBasicMaterial({color:a}),l=new c.Geometry,l.vertices.push(new c.Vector3(i.children[0].position.x+i.children[0].geometry.boundingBox.max.x,j.children[0].position.y,j.children[0].position.z),new c.Vector3(d.x,d.y,d.z)),t=new c.Line(l,v),s.add(j),s.add(t),F.add(s),z()},b}(b),this.Cut3d=a}).call(this);