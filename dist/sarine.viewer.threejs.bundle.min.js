/*!
sarine.viewer.threejs - v0.4.0 -  Tuesday, May 19th, 2015, 4:55:35 PM 
 The source code, name, and look and feel of the software are Copyright Â© 2015 Sarine Technologies Ltd. All Rights Reserved. You may not duplicate, copy, reuse, sell or otherwise exploit any portion of the code, content or visual design elements without express written permission from Sarine Technologies Ltd. The terms and conditions of the sarine.com website (http://sarine.com/terms-and-conditions/) apply to the access and use of this software.
 */
(function(){var a,b,c={}.hasOwnProperty,d=function(a,b){function d(){this.constructor=a}for(var e in b)c.call(b,e)&&(a[e]=b[e]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};b=function(){function a(b){console.log(""),this.first_init_defer=$.Deferred(),this.full_init_defer=$.Deferred(),this.src=b.src,this.element=b.element,this.autoPlay=b.autoPlay,this.callbackPic=b.callbackPic,this.id=this.element[0].id,this.element=this.convertElement(),Object.getOwnPropertyNames(a.prototype).forEach(function(a){return"Error"===this[a].name?console.error(this.id,a,"Must be implement",this):void 0},this),this.element.data("class",this),this.element.on("play",function(a){return $(a.target).data("class").play.apply($(a.target).data("class"),[!0])}),this.element.on("stop",function(a){return $(a.target).data("class").stop.apply($(a.target).data("class"),[!0])}),this.element.on("cancel",function(a){return $(a.target).data("class").cancel().apply($(a.target).data("class"),[!0])})}var b,c;return c=ResourceManager.getInstance(),b=function(){return console.error(this.id,"must be implement")},a.prototype.first_init=Error,a.prototype.full_init=Error,a.prototype.play=Error,a.prototype.stop=Error,a.prototype.convertElement=Error,a.prototype.cancel=function(){return c.cancel(this)},a.prototype.loadImage=function(a){return c.loadImage.apply(this,[a])},a.prototype.setTimeout=function(a,b){return c.setTimeout.apply(this,[this.delay,b])},a}(),this.Viewer=b,a=function(a){function b(a){b.__super__.constructor.call(this,a),h=a.color,p=a.font,s=a.infoOnly,h=h||16777215,C=1,this.version=$(this.element).data("version")||"v1",this.viewersBaseUrl=stones[0].viewersBaseUrl}var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F;return d(b,a),D=void 0,E=void 0,z=void 0,i=void 0,u=void 0,b.material=void 0,e=void 0,f=void 0,C=void 0,F=void 0,r=void 0,g=void 0,q=void 0,h=void 0,p=void 0,v=!1,w=!1,x=!1,s=!1,r=!1,o=void 0,b.prototype.getScene=function(){return D},b.prototype.getRenderer=function(){return z},b.prototype.convertElement=function(){return this.element.css({width:"100%",height:"100%","min-width":200,"min-height":200}),this.element},b.prototype.first_init=function(){var a,b;return b=this,a=$.Deferred(),t(this.viewersBaseUrl+"atomic/"+this.version+"/assets/three.bundle.js").then(function(){return j.apply(b),$.when($.get(b.src+"SRNSRX.srn"),$.getJSON(b.src+"Info.json")).then(function(d,e){var f;return r=e[0],f=d[0].replace(/\s/g,"^").match(/Mesh(.*?)}/)[0].replace(/[Mesh|{|}]/g,"").split("^").filter(function(a){return a.length>0}),m.apply(b,[{vertices:f.slice(1,+parseInt(f[0])+1||9e9).map(function(a){return a.replace(",","").split(";").slice(0,3)}),polygons:f.slice(parseInt(f[0])+2,+f.length+1||9e9).map(function(a){return a.replace(/(\d+;)/,"").replace(/(;;|;,)/,"").split(",")})}]),r=l.apply(b),s||c.apply(b),a.resolve(b)})}),a},b.prototype.full_init=function(){var a;return a=$.Deferred(),a.resolve(this),a},b.prototype.play=function(){},b.prototype.stop=function(){},t=function(a){var b,c,d;return d=this,b=$.Deferred(),$("[src='"+a+"']")[0]?($("[src='"+a+"']").on("load",function(){return b.resolve(d)}),b):(c=$("<script>",{type:"text/javascript"}).appendTo("body").end()[0],c.onload=function(){return b.resolve(d)},c.src=a,b)},A=function(a,b){return u.rotation.x+=b/100,u.rotation.z-=a/100},c=function(){var a,b,c,d,e,f;return a=z.domElement,d=function(a){var b,c;if(v)return a.preventDefault(),b=a.clientX-w,c=a.clientY-x,w=a.clientX,x=a.clientY,A(b,c)},e=function(a){return a.preventDefault(),v=!0,w=a.clientX,x=a.clientY},f=function(a){return a.preventDefault(),v=!1},c=function(a){return function(a){return 1===a.touches.length?(a.preventDefault(),w=a.touches[0].pageX,x=a.touches[0].pageY):void 0}}(this),b=function(a){return function(a){var b,c;return 1===a.touches.length?(a.preventDefault(),b=a.touches[0].pageX-w,c=a.touches[0].pageY-x,w=a.touches[0].pageX,x=a.touches[0].pageY,A(b,c)):void 0}}(this),z.domElement.addEventListener("touchstart",c,!1),document.getElementsByTagName("body")[0].addEventListener("touchend",f,!1),document.getElementsByTagName("body")[0].addEventListener("touchmove",b,!1),document.getElementsByTagName("body")[0].addEventListener("mousemove",d,!1),z.domElement.addEventListener("mousedown",e,!1),document.getElementsByTagName("body")[0].addEventListener("mouseup",f,!1)},y=function(){return u&&(o.rotation.x=u.rotation.x,o.rotation.z=u.rotation.z,o.updateMatrix()),s||requestAnimationFrame(y),z.clear(),z.render(D,e),u&&u.rotation&&parseInt(10*u.rotation.x)===parseInt(5*Math.PI)?z.render(E,f):void 0},m=function(a){var b,c,d,e,f,g,h,i,j;for(c=function(a,b){return b.faces.push(new THREE.Face3(a[0],a[1],a[2])),3!==a.length&&(a.splice(1,1),c(a,b)),b.computeFaceNormals()},b=new THREE.Geometry,i=a.vertices,e=0,g=i.length;g>e;e++)d=i[e],b.vertices.push(new THREE.Vector3(d[0]*C,d[1]*C,d[2]*C));for(j=a.polygons,f=0,h=j.length;h>f;f++)d=j[f],c(d,b);return u=new THREE.Mesh(b,this.material),u.material.opacity=1,u.material.transparent=!1,u.geometry.center(),D.add(B(u)),o=new THREE.EdgesHelper(u.clone(),0),o.renderOrder=1,o.material.linewidth=2,D.add(B(o)),o.position.setZ(100),o.updateMatrix(),u},B=function(a){return a.rotation.x=Math.PI/2,a},j=function(){return D=new THREE.Scene,E=new THREE.Scene,e=new THREE.OrthographicCamera(-4800,4800,4800,-4800,-1e4,1e4),D.add(e),e.position.set(0,0,5e3),e.lookAt(D.position),z=new THREE.WebGLRenderer({alpha:!0,logarithmicDepthBuffer:!1}),z.autoClear=!1,g=this.element.height()>this.element.width()?this.element.width():this.element.height(),f=new THREE.OrthographicCamera(g/-2,g/2,g/2,g/-2,-1e4,1e4),E.add(f),z.setSize(g,g),this.element[0].appendChild(z.domElement),this.material=new THREE.MeshBasicMaterial({color:13421772}),y()},k=function(a){var b,c,d,g,h,i,j,k,l,m,o,p,q;return k=a.name,l=a.origin,j=a.length,h=a.hex,o=a.topToButtom,b=a.data,c=a.dir,d=a.far,q=o?"x":"y",l["set"+q.toUpperCase()](l[q]*d),l.set(l.x/(e.right/f.right),l.y/(e.right/f.right),l.z/(e.right/f.right)),m=n({text:b.toFixed(2)+" mm",position:l}),i=new THREE.Object3D,i.name="info",p=o?"y":"x",g=m.geometry.boundingBox.max[p]-m.geometry.boundingBox.min[p]+10,j=b/2*1e3/(e.right/f.right)-g/2,i.add(m),i.add(new THREE.ArrowHelper(c,l.clone()["set"+p.toUpperCase()](l[p]+g/2),j,h,5,5)),o?c.setY(-1*c.y):c.setX(-1*c.x),i.add(new THREE.ArrowHelper(c,l.clone()["set"+p.toUpperCase()](l[p]-g/2),j,h,5,5)),i},n=function(a){var b,c,d,f,g,h;return f=a.text,d=a.position,b=a.hex,c=new THREE.MeshBasicMaterial({color:a.hex||0}),g=new THREE.TextGeometry(a.text,{size:15,font:"gentilis",wieght:"bold"}),g.center(),h=new THREE.Mesh(g,c),h.lookAt(e.position),h.position.set(d.x,d.y,d.z),h},l=function(a){var b,c;return a=a||0,b=new THREE.Object3D,b.name="info",b.add(k({origin:new THREE.Vector3(0,u.geometry.boundingBox.max.z,0),hex:a,topToButtom:!1,data:r.Length.mm,dir:new THREE.Vector3(1,0,0),far:1.5})),b.add(k({origin:new THREE.Vector3(0,u.geometry.boundingBox.max.z,0),hex:a,topToButtom:!1,data:r["Table Size"].mm,dir:new THREE.Vector3(1,0,0),far:1.25})),c=u.geometry.boundingBox.max.z-1e3*r.Crown["height-mm"]/2,b.add(k({origin:new THREE.Vector3(u.geometry.boundingBox.max.x,c,0),hex:a,topToButtom:!0,data:r.Crown["height-mm"],dir:new THREE.Vector3(u.geometry.boundingBox.max.x,c+1,0),far:1.15})),c=u.geometry.boundingBox.min.z+1e3*r.Pavilion["height-mm"]/2,b.add(k({origin:new THREE.Vector3(u.geometry.boundingBox.max.x,c,0),hex:a,topToButtom:!0,data:r.Pavilion["height-mm"],dir:new THREE.Vector3(u.geometry.boundingBox.max.x,-1*c,0),far:1.15})),c=u.geometry.boundingBox.min.z+1e3*r["Total Depth"].mm/2,b.add(k({origin:new THREE.Vector3(u.geometry.boundingBox.min.x,c,0),hex:a,topToButtom:!0,data:r["Total Depth"].mm,dir:new THREE.Vector3(u.geometry.boundingBox.min.x,c+1,0),far:1.15})),E.add(b),void y()},b}(b),this.Threejs=a}).call(this);